<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿å›¾ç‰‡åˆ‡ç‰‡å·¥å…·</title>
    <!-- å¼•å…¥ JSZip ç”¨äºæ‰“åŒ…ä¸‹è½½ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #2196F3;
            --bg-color: #f5f5f5;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        h1 { margin-top: 0; color: #444; }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .input-group label {
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="number"], input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
            margin: 5px;
        }

        button:hover { background-color: #1976D2; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        button.secondary {
            background-color: #4CAF50;
        }
        button.secondary:hover { background-color: #388E3C; }

        #preview-area {
            margin-top: 20px;
            border: 2px dashed #ddd;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            overflow: auto;
        }

        /* ç½‘æ ¼å±•ç¤ºåˆ‡ç‰‡ */
        .grid-display {
            display: grid;
            gap: 2px; /* åˆ‡ç‰‡ä¹‹é—´çš„é—´éš™ */
            background-color: #eee;
            border: 1px solid #ccc;
        }

        .grid-item {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.2s;
        }
        
        .grid-item:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .info {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>âœ‚ï¸ åœ¨çº¿å›¾ç‰‡åˆ‡ç‰‡å·¥å…·</h1>
        
        <div class="controls">
            <div class="input-group">
                <label>1. é€‰æ‹©å›¾ç‰‡</label>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <div class="input-group">
                <label>æ¨ªå‘åˆ‡å‰² (è¡Œæ•°)</label>
                <input type="number" id="rowsInput" value="3" min="1">
            </div>
            <div class="input-group">
                <label>ç«–å‘åˆ‡å‰² (åˆ—æ•°)</label>
                <input type="number" id="colsInput" value="3" min="1">
            </div>
        </div>

        <div>
            <button id="sliceBtn" onclick="processImage()">å¼€å§‹åˆ‡å‰²é¢„è§ˆ</button>
            <button id="downloadBtn" class="secondary hidden" onclick="downloadZip()">ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰åˆ‡ç‰‡</button>
        </div>

        <p class="info" id="statusMsg">è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è®¾ç½®å‚æ•°</p>

        <div id="preview-area">
            <span style="color: #999;">é¢„è§ˆåŒºåŸŸ</span>
        </div>
    </div>

    <script>
        let originalImage = null;
        let slicedImages = []; // å­˜å‚¨åˆ‡å¥½çš„å›¾ç‰‡æ•°æ® Blob
        let originalFileName = "image";

        // ç›‘å¬æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            originalFileName = file.name.split('.')[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    document.getElementById('statusMsg').innerText = `å›¾ç‰‡åŠ è½½æˆåŠŸ: ${img.width}x${img.height}px`;
                    // è‡ªåŠ¨è§¦å‘ä¸€æ¬¡é¢„è§ˆï¼ˆå¯é€‰ï¼‰
                    // processImage();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        function processImage() {
            if (!originalImage) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼");
                return;
            }

            const rows = parseInt(document.getElementById('rowsInput').value);
            const cols = parseInt(document.getElementById('colsInput').value);
            
            if (rows < 1 || cols < 1) {
                alert("è¡Œæ•°å’Œåˆ—æ•°å¿…é¡»å¤§äº0");
                return;
            }

            const previewArea = document.getElementById('preview-area');
            previewArea.innerHTML = ''; // æ¸…ç©º
            slicedImages = []; // é‡ç½®å­˜å‚¨

            // åˆ›å»ºç½‘æ ¼å®¹å™¨
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid-display';
            gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            // é™åˆ¶é¢„è§ˆå›¾æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æ’‘çˆ†é¡µé¢
            gridContainer.style.maxWidth = '100%'; 
            
            // è®¡ç®—æ¯å—çš„å°ºå¯¸
            const itemWidth = Math.floor(originalImage.width / cols);
            const itemHeight = Math.floor(originalImage.height / rows);

            // éå†åˆ‡å‰²
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const canvas = document.createElement('canvas');
                    canvas.width = itemWidth;
                    canvas.height = itemHeight;
                    const ctx = canvas.getContext('2d');

                    // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
                    ctx.drawImage(
                        originalImage, 
                        c * itemWidth, r * itemHeight, itemWidth, itemHeight, // æºå›¾åæ ‡å’Œå°ºå¯¸
                        0, 0, itemWidth, itemHeight // ç›®æ ‡ç”»å¸ƒåæ ‡å’Œå°ºå¯¸
                    );

                    // 1. ç”¨äºæ˜¾ç¤ºçš„ img æ ‡ç­¾
                    const imgTag = document.createElement('img');
                    imgTag.src = canvas.toDataURL('image/png');
                    imgTag.className = 'grid-item';
                    imgTag.title = `ç¬¬${r+1}è¡Œ, ç¬¬${c+1}åˆ— (ç‚¹å‡»ä¸‹è½½è¿™å¼ )`;
                    
                    // å•å‡»å•ç‹¬ä¸‹è½½
                    (function(row, col, dataUrl) {
                        imgTag.onclick = () => {
                            const link = document.createElement('a');
                            link.download = `${originalFileName}_${row+1}_${col+1}.png`;
                            link.href = dataUrl;
                            link.click();
                        };
                    })(r, c, canvas.toDataURL('image/png'));

                    gridContainer.appendChild(imgTag);

                    // 2. å°†æ•°æ®å­˜å…¥ slicedImages æ•°ç»„ç”¨äºæ‰“åŒ…ä¸‹è½½
                    // canvas è½¬ blob
                    canvas.toBlob((blob) => {
                        slicedImages.push({
                            name: `${originalFileName}_${r+1}_${c+1}.png`,
                            blob: blob
                        });
                        
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å›¾ç‰‡éƒ½å¤„ç†å®Œæ¯•
                        if (slicedImages.length === rows * cols) {
                             document.getElementById('downloadBtn').classList.remove('hidden');
                             document.getElementById('statusMsg').innerText = `åˆ‡å‰²å®Œæˆï¼å…± ${rows*cols} å¼ å›¾ç‰‡ã€‚`;
                        }
                    }, 'image/png');
                }
            }
            
            previewArea.appendChild(gridContainer);
        }

        function downloadZip() {
            if (slicedImages.length === 0) return;

            const zip = new JSZip();
            const folder = zip.folder("split_images");

            slicedImages.forEach(item => {
                folder.file(item.name, item.blob);
            });

            document.getElementById('downloadBtn').innerText = "æ­£åœ¨æ‰“åŒ…...";
            
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, `${originalFileName}_split.zip`);
                document.getElementById('downloadBtn').innerText = "ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰åˆ‡ç‰‡";
            });
        }
    </script>
</body>
</html>