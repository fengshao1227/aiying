# 微信支付模块开发计划

> 生成时间：2025-12-22
> 任务：小程序微信支付功能开发
> 技术方案：微信官方SDK (wechatpay/wechatpay-php)

---

## 任务概述

**目标**: 实现小程序微信支付功能，支持商品订单和套餐订单支付，包含支付回调和企业微信通知

**技术架构**:
```
前端(uni-app) → 后端API → 微信支付 → 支付回调 → 订单更新 → 企业微信通知
```

---

## 配置信息

**微信支付配置**:
- AppID: wxccf8804f6f48fb46
- 商户号: 1635595538
- APIV3密钥: kRc1pvCcaq9jK1qzWGST6lGfso9uiJrY
- 证书路径: storage/wechat_pay/
- 回调地址: https://aiying.qdhs.cloud/api/payments/wechat/notify

**企业微信Webhook**:
- URL: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=8b9d2a7f-7f27-4471-adcf-ad09f1dccf0b

---

## 实施阶段

### 阶段1: 环境准备与配置 ✅
- [x] 安装微信支付SDK
- [x] 创建配置文件 config/wechat_pay.php
- [x] 更新.env配置
- [x] 创建证书目录

### 阶段2: 后端核心功能开发
- [ ] 创建WechatPayService服务类
- [ ] 创建PaymentController控制器
- [ ] 更新Order模型
- [ ] 创建WorkWechatNotifyService服务
- [ ] 注册API路由

### 阶段3: 前端支付集成
- [ ] 更新订单API (goods_order_new.js)
- [ ] 创建支付工具函数 (utils/payment.js)
- [ ] 更新订单确认页面 (cashier.vue)
- [ ] 更新家属订餐API (family_meals_new.js)

### 阶段4: 测试与验证
- [ ] 创建测试脚本
- [ ] 沙箱环境测试
- [ ] 生产环境预发布测试

### 阶段5: 文档与部署
- [ ] 生成API文档
- [ ] 创建部署脚本
- [ ] 更新项目文档

---

## 核心接口定义

### 1. 发起支付
```
POST /api/orders/{id}/pay
Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "支付参数获取成功",
  "data": {
    "appId": "wxccf8804f6f48fb46",
    "timeStamp": "1703145600",
    "nonceStr": "abc123",
    "package": "prepay_id=wx2023122112345678",
    "signType": "RSA",
    "paySign": "..."
  }
}
```

### 2. 支付回调
```
POST /api/payments/wechat/notify
Content-Type: application/json

微信支付回调数据（加密）
→ 验证签名
→ 解密数据
→ 更新订单
→ 发送通知
→ 返回成功
```

---

## 关键风险点

1. ⚠️ 证书文件需要用户后续提供
2. ⚠️ 支付回调需要域名可访问（https://aiying.qdhs.cloud）
3. ⚠️ 企业微信Webhook需要创建群

---

## 预计工时

- 环境准备: 0.5小时
- 后端开发: 3小时
- 前端集成: 1.5小时
- 测试验证: 1.5小时
- 文档部署: 0.5小时

**总计**: 5-7小时

---

## 交付物

1. ✅ 总结性Markdown文档
2. ✅ 测试脚本
3. ✅ 编译部署
4. ✅ 运行验证
