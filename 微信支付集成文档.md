# 微信支付集成完整文档

## 📋 目录
- [项目概述](#项目概述)
- [系统架构](#系统架构)
- [后端实现](#后端实现)
- [前端实现](#前端实现)
- [API接口文档](#api接口文档)
- [测试指南](#测试指南)
- [常见问题](#常见问题)
- [部署说明](#部署说明)

---

## 项目概述

### 实现内容
为"爱颖"小程序集成微信JSAPI支付功能,支持商品订单和套餐订单的在线支付,并在支付成功后通过企业微信发送通知。

### 技术栈
- **后端**: Laravel 12 + PHP 8.3
- **前端**: uni-app (Vue 2)
- **支付**: 微信支付APIV3
- **签名**: SHA256-RSA
- **加密**: AEAD_AES_256_GCM
- **通知**: 企业微信Webhook

### 关键配置信息
- **AppID**: wxccf8804f6f48fb46
- **商户号**: 1635595538
- **证书序列号**: 6BA5275A17CD7E12E1266C8A9B917F4497C6F214

---

## 系统架构

### 支付流程图
```
小程序客户端                    后端服务器                     微信支付服务器              企业微信
     |                             |                              |                          |
     |--1.创建订单---------------->|                              |                          |
     |<--订单信息-------------------|                              |                          |
     |                             |                              |                          |
     |--2.发起支付(POST /pay)----->|                              |                          |
     |                             |--3.统一下单API-------------->|                          |
     |                             |<--prepay_id------------------|                          |
     |<--4.支付参数(paySign)--------|                              |                          |
     |                             |                              |                          |
     |--5.调起微信支付------------>|                              |                          |
     |                             |                              |                          |
     |<--支付结果-----------------微信APP内部处理------------------->|                          |
     |                             |                              |                          |
     |                             |<--6.支付回调通知-------------|                          |
     |                             |--7.验签/解密                 |                          |
     |                             |--8.更新订单状态              |                          |
     |                             |--9.创建支付记录              |                          |
     |                             |--10.发送通知----------------------------------------->|
     |                             |                              |                          |
     |<--11.跳转结果页面------------|                              |                          |
```

### 核心组件

#### 后端组件
1. **WechatPayService** - 微信支付核心服务
2. **PaymentController** - 支付控制器
3. **WorkWechatNotifyService** - 企业微信通知服务
4. **Order Model** - 订单模型(含支付方法)

#### 前端组件
1. **payment.js** - 支付工具函数
2. **goods_order_new.js** - 商品订单API
3. **family_meals_new.js** - 套餐订单API

---

## 后端实现

### 1. 配置文件

#### config/wechat_pay.php
```php
<?php
return [
    'appid' => env('WECHAT_PAY_APPID'),                    // 小程序AppID
    'mch_id' => env('WECHAT_PAY_MCH_ID'),                 // 商户号
    'api_v3_key' => env('WECHAT_PAY_API_V3_KEY'),         // APIV3密钥
    'serial_no' => env('WECHAT_PAY_SERIAL_NO'),           // 证书序列号
    'private_key_path' => storage_path('wechat_pay/apiclient_key.pem'),
    'cert_path' => storage_path('wechat_pay/apiclient_cert.pem'),
    'notify_url' => env('APP_URL') . '/api/payments/wechat/notify',
    'api_url' => 'https://api.mch.weixin.qq.com',
    'work_wechat_webhook' => env('WECHAT_WORK_WEBHOOK'),
];
```

#### .env 配置
```env
WECHAT_PAY_APPID=wxccf8804f6f48fb46
WECHAT_PAY_MCH_ID=1635595538
WECHAT_PAY_API_V3_KEY=kRc1pvCcaq9jK1qzWGST6lGfso9uiJrY
WECHAT_PAY_SERIAL_NO=6BA5275A17CD7E12E1266C8A9B917F4497C6F214
WECHAT_WORK_WEBHOOK=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=8b9d2a7f-7f27-4471-adcf-ad09f1dccf0b
```

### 2. 核心类

#### WechatPayService.php
**位置**: `app/Services/WechatPayService.php`

**主要方法**:
- `createJsapiOrder()` - JSAPI统一下单
- `generateMiniProgramPayParams()` - 生成小程序支付参数
- `verifyAndDecryptNotify()` - 验证并解密支付回调
- `request()` - 发起HTTP请求
- `sign()` - SHA256-RSA签名
- `decryptResource()` - AEAD_AES_256_GCM解密

**签名算法**:
```php
protected function sign(string $method, string $url, string $timestamp, string $nonce, string $body): string
{
    $message = implode("\n", [$method, $url, $timestamp, $nonce, $body, '']);
    openssl_sign($message, $signature, $this->privateKey, OPENSSL_ALGO_SHA256);
    return base64_encode($signature);
}
```

#### PaymentController.php
**位置**: `app/Http/Controllers/Api/PaymentController.php`

**路由**:
- `POST /api/orders/{id}/pay` - 发起支付
- `POST /api/payments/wechat/notify` - 支付回调

**关键代码**:
```php
public function pay(Request $request, $id): JsonResponse
{
    $user = User::where('openid', $request->header('X-Openid'))->first();
    $order = Order::where('user_id', $user->id)->where('id', $id)->first();

    if (!$order->canPay()) {
        return response()->json(['code' => 400, 'message' => '订单状态不允许支付'], 400);
    }

    $paymentParams = $this->wechatPayService->createJsapiOrder($order, $user->openid);
    return response()->json(['code' => 200, 'data' => $paymentParams]);
}
```

#### WorkWechatNotifyService.php
**位置**: `app/Services/WorkWechatNotifyService.php`

**通知格式**:
```php
[
    'msgtype' => 'markdown',
    'markdown' => [
        'content' => "## 💰 新订单支付成功\n\n" .
                     "**订单类型**: 商品订单\n" .
                     "**订单号**: ORD202512220001\n" .
                     "**用户**: 张小美 (138****0001)\n" .
                     "**商品**: 婴儿防踢被 x1\n" .
                     "**金额**: ¥89.00\n" .
                     "**支付时间**: 2025-12-22 15:30:00\n"
    ]
]
```

### 3. 数据库变更

#### Order模型新增字段
```php
protected $fillable = [
    // ... 原有字段
    'payment_method',    // 支付方式
    'payment_time',      // 支付时间
    'transaction_id',    // 微信交易号
];
```

#### Order模型新增方法
```php
public function canPay(): bool; // 检查是否可支付
public function markAsPaid(string $transactionId, array $paymentData): void; // 标记为已支付
public function getPaymentDescription(): string; // 获取支付描述
```

---

## 前端实现

### 1. API更新

#### goods_order_new.js
```javascript
/**
 * 发起支付
 * @param {number} orderId 订单ID
 * @returns {Promise} 返回微信支付参数
 */
export function createPayment(orderId) {
    return request(`/orders/${orderId}/pay`, 'POST');
}
```

#### family_meals_new.js
```javascript
/**
 * 发起支付
 * @param {number} orderId 订单ID
 * @returns {Promise} 返回微信支付参数
 */
export function createPayment(orderId) {
    return request(`/orders/${orderId}/pay`, 'POST');
}
```

### 2. 支付工具函数

#### utils/payment.js
**核心函数**:
```javascript
/**
 * 发起微信支付
 * @param {number} orderId - 订单ID
 * @param {string} orderType - 订单类型 'goods' | 'family'
 */
export async function initiateWechatPay(orderId, orderType = 'goods') {
    // 1. 获取支付参数
    const paymentData = await createPaymentFn(orderId);
    const params = paymentData.data;

    // 2. 调用微信支付
    return new Promise((resolve, reject) => {
        uni.requestPayment({
            provider: 'wxpay',
            timeStamp: params.timeStamp,
            nonceStr: params.nonceStr,
            package: params.package,
            signType: params.signType,
            paySign: params.paySign,
            success: resolve,
            fail: reject
        });
    });
}
```

**辅助函数**:
- `payGoodsOrder(orderId)` - 商品订单支付
- `payFamilyMealOrder(orderId)` - 套餐订单支付
- `needPayment(order)` - 检查订单是否需要支付
- `getPaymentStatusText(status)` - 获取支付状态文本

### 3. 使用示例

#### 订单详情页调用支付
```javascript
import { payGoodsOrder } from '@/utils/payment.js';

methods: {
    async handlePay() {
        try {
            await payGoodsOrder(this.orderId);
            // 支付成功,刷新订单状态
            this.loadOrderDetail();
        } catch (error) {
            console.error('支付失败', error);
        }
    }
}
```

---

## API接口文档

### 1. 发起支付

**接口**: `POST /api/orders/{id}/pay`

**请求头**:
```
X-Openid: wx_test_user_001
```

**请求参数**: 无

**成功响应** (200):
```json
{
    "code": 200,
    "message": "支付参数获取成功",
    "data": {
        "appId": "wxccf8804f6f48fb46",
        "timeStamp": "1703238000",
        "nonceStr": "abc123def456",
        "package": "prepay_id=wx2212345678901234567890",
        "signType": "RSA",
        "paySign": "Hjk8dF3j..."
    }
}
```

**错误响应**:
- 401: 未登录
- 404: 订单不存在
- 400: 订单状态不允许支付
- 500: 发起支付失败

### 2. 支付回调

**接口**: `POST /api/payments/wechat/notify`

**请求头**:
```
Wechatpay-Signature: ...
Wechatpay-Timestamp: ...
Wechatpay-Nonce: ...
Wechatpay-Serial: ...
```

**请求体**: 微信加密的支付通知数据

**成功响应**: 200 (空响应体)

**说明**: 此接口由微信服务器调用,无需前端直接调用。

---

## 测试指南

### 1. 后端测试

#### 使用测试脚本
```bash
# 赋予执行权限
chmod +x test-wechat-pay.sh

# 运行测试
./test-wechat-pay.sh
```

**测试流程**:
1. 管理员登录获取token
2. 获取用户列表
3. 测试发起支付接口
4. 模拟支付回调接口

### 2. 小程序真机测试

#### 准备工作
1. 确保小程序已配置AppID
2. 确保商户号已开通JSAPI支付
3. 确保支付目录已配置

#### 测试步骤
1. **创建订单**
   - 打开小程序
   - 选择商品/套餐
   - 填写收货地址
   - 创建订单

2. **发起支付**
   - 进入订单详情页
   - 点击"去支付"按钮
   - 调起微信支付
   - 输入支付密码

3. **验证结果**
   - 检查订单状态是否更新为"已支付"
   - 检查企业微信是否收到通知
   - 检查数据库payment_status字段

### 3. 支付回调测试

由于支付回调需要微信服务器发送,无法在本地完全模拟。建议使用:

**方式1**: 内网穿透工具(如ngrok)
```bash
ngrok http 443
# 将生成的https地址配置到微信商户平台
```

**方式2**: 微信支付沙箱环境
- 申请沙箱环境
- 使用沙箱商户号和密钥
- 参考: https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_1

---

## 常见问题

### Q1: 支付时提示"签名错误"
**原因**:
- 私钥文件路径错误
- 证书序列号不匹配
- 签名算法实现错误

**解决**:
```bash
# 检查证书文件
ls -la storage/wechat_pay/
-rw------- apiclient_key.pem
-rw------- apiclient_cert.pem

# 验证序列号
openssl x509 -in storage/wechat_pay/apiclient_cert.pem -noout -serial
```

### Q2: 支付回调未触发
**原因**:
- 回调URL不可访问
- 未配置HTTPS
- 服务器防火墙拦截

**解决**:
```bash
# 测试回调URL可访问性
curl https://aiying.qdhs.cloud/api/payments/wechat/notify

# 检查Laravel日志
tail -f storage/logs/laravel.log
```

### Q3: 解密回调数据失败
**原因**:
- APIV3密钥配置错误
- 加密算法实现错误

**解决**:
```php
// 验证APIV3密钥长度(应为32字符)
echo strlen(config('wechat_pay.api_v3_key')); // 输出: 32
```

### Q4: 企业微信通知未发送
**原因**:
- Webhook地址配置错误
- 群机器人未启用

**解决**:
```bash
# 测试Webhook可用性
curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY" \
  -H "Content-Type: application/json" \
  -d '{"msgtype":"text","text":{"content":"测试消息"}}'
```

---

## 部署说明

### 1. 环境要求
- PHP >= 8.3
- Laravel 12
- MySQL/PostgreSQL
- HTTPS (必需)
- OpenSSL扩展

### 2. 部署步骤

#### 后端部署
```bash
# 1. 上传证书文件
mkdir -p storage/wechat_pay
chmod 700 storage/wechat_pay
cp apiclient_key.pem storage/wechat_pay/
cp apiclient_cert.pem storage/wechat_pay/
chmod 600 storage/wechat_pay/*.pem
chown www:www storage/wechat_pay/*.pem

# 2. 配置环境变量
vim .env
# 添加微信支付配置...

# 3. 清除缓存
php artisan config:clear
php artisan config:cache
php artisan route:clear
php artisan route:cache

# 4. 测试配置
php artisan tinker
>>> config('wechat_pay.mch_id');
```

#### 前端部署
```bash
# 1. 更新代码
git pull

# 2. 安装依赖(如需要)
npm install

# 3. 构建小程序
# 使用HBuilderX或CLI工具构建

# 4. 上传代码
# 通过微信开发者工具上传
```

### 3. 配置检查清单
- [ ] .env中所有WECHAT_PAY_*配置已填写
- [ ] 证书文件已上传且权限正确(600)
- [ ] 回调URL可通过HTTPS访问
- [ ] 企业微信Webhook可用
- [ ] 小程序AppID与配置一致
- [ ] 商户号已开通JSAPI支付
- [ ] 支付目录已在商户平台配置

### 4. 安全建议
1. **证书保护**
   - 证书文件权限设为600
   - 不要将证书提交到版本控制
   - 定期更新证书

2. **密钥管理**
   - APIV3密钥不要硬编码
   - 使用环境变量存储
   - 定期更换密钥

3. **回调验签**
   - 必须验证回调签名
   - 验证通知来源
   - 防止重放攻击

4. **日志审计**
   - 记录所有支付请求
   - 记录回调处理过程
   - 定期审查异常日志

---

## 技术支持

### 相关文档
- [微信支付APIV3开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [小程序支付开发指南](https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html)
- [企业微信群机器人配置](https://developer.work.weixin.qq.com/document/path/91770)

### 日志位置
- **后端日志**: `storage/logs/laravel.log`
- **小程序日志**: 微信开发者工具控制台

### 测试工具
- **接口测试**: Postman/cURL
- **签名验证**: [微信支付签名验证工具](https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pay/transactions/chapter7_2.shtml)
- **证书工具**: OpenSSL

---

**文档版本**: v1.0
**最后更新**: 2025-12-22
**维护人员**: AI Assistant
