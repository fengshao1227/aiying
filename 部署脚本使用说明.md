# 部署脚本使用说明

## 📦 脚本列表

项目包含以下自动化部署脚本：

| 脚本名称 | 功能说明 | 使用场景 |
|---------|---------|---------|
| `deploy.sh` | 完整部署脚本 | 正式发布、功能更新 |
| `quick-update.sh` | 快速更新脚本 | 紧急修复、小改动 |
| `check-server.sh` | 服务器检查脚本 | 环境诊断、状态监控 |
| `rollback.sh` | 代码回滚脚本 | 版本回退、问题修复 |
| `test-api.sh` | API测试脚本 | 接口测试、功能验证 |

---

## 🚀 快速开始

### 1. 赋予执行权限

首次使用前，需要为所有脚本赋予执行权限：

```bash
chmod +x deploy.sh quick-update.sh check-server.sh rollback.sh test-api.sh
```

### 2. 安装必要工具

#### macOS系统
```bash
# 安装Homebrew（如未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装sshpass
brew install hudochenkov/sshpass/sshpass
```

#### Linux系统
```bash
# Ubuntu/Debian
sudo apt-get update && sudo apt-get install -y sshpass

# CentOS/RHEL
sudo yum install -y sshpass
```

---

## 📋 详细使用说明

### 1. deploy.sh - 完整部署脚本

**功能**: 完整的自动化部署流程，包括代码提交、推送、服务器更新、缓存优化等。

**使用方法**:

```bash
# 基础部署（自动生成提交信息）
./deploy.sh

# 带自定义提交信息的部署
./deploy.sh "新增客户管理功能"
```

**执行流程**:
1. ✅ 检查必要工具（git、sshpass）
2. ✅ 检查Git状态
3. ✅ 提交本地更改
4. ✅ 推送到远程仓库
5. ✅ 连接服务器
6. ✅ 拉取最新代码
7. ✅ 更新Composer依赖（如需要）
8. ✅ 清理和优化缓存
9. ✅ 修正文件权限

**适用场景**:
- ✅ 功能开发完成后的正式发布
- ✅ 重大更新和版本发布
- ✅ 需要更新依赖的情况

---

### 2. quick-update.sh - 快速更新脚本

**功能**: 极速部署，适用于紧急修复和小改动，省略了部分检查步骤。

**使用方法**:

```bash
# 快速部署（自动生成提交信息）
./quick-update.sh

# 带自定义提交信息
./quick-update.sh "修复登录bug"
```

**执行流程**:
1. ⚡ 快速提交本地更改
2. ⚡ 推送到远程仓库
3. ⚡ 服务器快速更新和缓存优化

**适用场景**:
- ⚡ 紧急bug修复
- ⚡ 配置文件小改动
- ⚡ 样式或文本调整
- ⚡ 不涉及依赖变更的更新

**对比deploy.sh的差异**:
- ✅ 执行速度更快（省略依赖检查）
- ✅ 步骤更少，输出更简洁
- ⚠️ 不检查composer依赖变化
- ⚠️ 适合小改动，不适合大更新

---

### 3. check-server.sh - 服务器检查脚本

**功能**: 全面检查服务器环境、项目状态、系统资源等信息。

**使用方法**:

```bash
./check-server.sh
```

**检查项目**:
- 🖥️ **系统信息**: 主机名、系统版本、CPU、内存、磁盘
- 🐘 **PHP环境**: PHP版本、配置文件、已安装扩展
- 📦 **Composer**: Composer版本信息
- 🗄️ **MySQL数据库**: 版本、连接状态、数据库列表
- 🌐 **Nginx**: 版本、运行状态、配置文件
- 📂 **项目状态**:
  - Git仓库状态、当前分支、最新提交
  - .env环境配置
  - 目录权限
  - Composer依赖
  - 项目大小
- 🔌 **网络连接**: 监听端口（80, 443, 3306, 9000）
- 📊 **系统负载**: 负载平均值、运行时间、内存使用
- 📝 **日志**: Laravel日志、Nginx错误日志

**适用场景**:
- 🔍 环境问题诊断
- 🔍 部署前状态检查
- 🔍 性能问题排查
- 🔍 日常运维监控

**输出示例**:
```
╔════════════════════════════════════════════════════════════╗
║            服务器状态检查                                  ║
╚════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════
 系统信息
═══════════════════════════════════════════════════════════
主机名: iZ2ze...
系统版本: CentOS Linux 7 (Core)
内核版本: 3.10.0-1160.el7.x86_64
CPU: 2 核心
内存: 4.0G
磁盘: 40G (已用 15G, 剩余 23G)

═══════════════════════════════════════════════════════════
 PHP环境
═══════════════════════════════════════════════════════════
✓ PHP版本: 8.3.1
PHP配置文件: /etc/php.ini
PHP扩展:
  - pdo_mysql
  - mbstring
  - openssl
  - json
  - curl
  - fileinfo
...
```

---

### 4. rollback.sh - 代码回滚脚本

**功能**: 将服务器代码回滚到指定版本或上一个版本。

**使用方法**:

```bash
# 回滚到上一个版本
./rollback.sh

# 回滚到指定版本（commit hash）
./rollback.sh abc1234
```

**执行流程**:
1. ⚠️ 显示回滚警告
2. ⚠️ 要求用户确认（输入yes）
3. 🔄 连接服务器执行git reset
4. 🔄 清理和优化缓存
5. 🔄 修正文件权限

**适用场景**:
- 🔄 新版本出现严重bug需要紧急回退
- 🔄 部署后发现功能问题
- 🔄 测试环境版本切换

**注意事项**:
- ⚠️ **此操作会丢失服务器上的未提交更改！**
- ⚠️ 请确保本地代码已提交到Git仓库
- ⚠️ 建议先使用check-server.sh查看当前版本
- ⚠️ 回滚前建议备份数据库（如有结构变更）

**查看版本历史**:
```bash
# 在服务器上查看提交历史
ssh root@82.157.47.215
cd /www/wwwroot/aiying-backend
git log --oneline -10
```

---

### 5. test-api.sh - API测试脚本

**功能**: 自动化测试所有后台管理API接口。

**使用方法**:

```bash
# 启动Laravel开发服务器（在另一个终端）
php artisan serve

# 运行API测试
./test-api.sh
```

**测试内容**:
1. 🧪 **认证系统测试**: 登录、获取信息、修改密码、退出
2. 🧪 **客户管理测试**: CRUD操作、搜索、筛选
3. 🧪 **房间管理测试**: CRUD操作、楼层筛选
4. 🧪 **房态管理测试**: 入住、退房、跨月记录
5. 🧪 **评分卡测试**: CRUD操作、日期筛选
6. 🧪 **数据清理测试**: 删除测试数据

**测试报告**:
```
╔═══════════════════════════════════════════════════════════╗
║    爱婴月子中心后台管理API测试工具                       ║
║    API Test Suite for Aiying Postpartum Care Center      ║
╚═══════════════════════════════════════════════════════════╝

========================================
1. 认证系统测试
========================================

[测试] 1.1 管理员登录
✓ 成功 - 登录成功
响应: {"code":200,"message":"登录成功",...}

总测试数: 35
通过: 35
失败: 0

╔═══════════════════════════════════════╗
║   🎉 所有测试通过！API运行正常！     ║
╚═══════════════════════════════════════╝
```

**适用场景**:
- 🧪 开发完成后的功能验证
- 🧪 部署前的接口测试
- 🧪 回归测试
- 🧪 CI/CD集成测试

---

## 🔧 服务器配置信息

### 当前配置
```
服务器IP: 82.157.47.215
用户名: root
密码: Aiying88
项目路径: /www/wwwroot/aiying-backend
```

### 修改服务器配置

如需修改服务器信息，编辑各脚本文件开头的配置变量：

```bash
SERVER_HOST="82.157.47.215"      # 服务器IP
SERVER_USER="root"               # SSH用户名
SERVER_PASSWORD="Aiying88"       # SSH密码
SERVER_PATH="/www/wwwroot/aiying-backend"  # 项目路径
```

---

## 📊 部署工作流程推荐

### 日常开发流程

```
开发代码 → 本地测试 → 提交到Git → 使用deploy.sh部署
```

### 紧急修复流程

```
修复bug → 简单测试 → 使用quick-update.sh快速部署
```

### 完整发布流程

```
1. 完成开发和本地测试
2. 运行 ./test-api.sh 验证接口
3. 使用 ./check-server.sh 检查服务器状态
4. 使用 ./deploy.sh "版本v1.0发布" 部署
5. 部署后再次运行 ./check-server.sh 确认
6. 如有问题使用 ./rollback.sh 回滚
```

---

## ⚠️ 注意事项

### 1. Git仓库配置

确保已配置Git远程仓库：

```bash
# 查看远程仓库
git remote -v

# 如未配置，添加远程仓库
git remote add origin <仓库地址>

# 首次推送设置上游分支
git push -u origin main
```

### 2. SSH密钥认证（可选）

为了更安全的连接，建议配置SSH密钥：

```bash
# 生成SSH密钥
ssh-keygen -t rsa -b 4096

# 复制公钥到服务器
ssh-copy-id root@82.157.47.215

# 配置后可修改脚本，移除密码参数
```

### 3. 服务器首次部署

首次在服务器部署项目需要手动操作：

```bash
# 1. SSH连接服务器
ssh root@82.157.47.215

# 2. 进入网站根目录
cd /www/wwwroot

# 3. 克隆项目
git clone <仓库地址> aiying-backend

# 4. 进入项目
cd aiying-backend

# 5. 安装依赖
composer install --no-dev --optimize-autoloader

# 6. 复制环境配置
cp .env.example .env

# 7. 编辑.env配置数据库等信息
vi .env

# 8. 生成应用密钥
php artisan key:generate

# 9. 设置权限
chown -R www:www /www/wwwroot/aiying-backend
chmod -R 755 /www/wwwroot/aiying-backend
chmod -R 775 /www/wwwroot/aiying-backend/storage
chmod -R 775 /www/wwwroot/aiying-backend/bootstrap/cache

# 10. 优化缓存
php artisan config:cache
php artisan route:cache
```

### 4. 数据库操作

脚本不会自动执行数据库迁移，需要手动操作：

```bash
# 连接服务器
ssh root@82.157.47.215

# 进入项目
cd /www/wwwroot/aiying-backend

# 执行SQL文件
mysql -h 82.157.47.215 -u root -pAiying@123456 aiying_health < new_tables.sql
```

### 5. 日志监控

查看Laravel日志：

```bash
# 实时监控日志
ssh root@82.157.47.215
tail -f /www/wwwroot/aiying-backend/storage/logs/laravel.log

# 查看Nginx错误日志
tail -f /var/log/nginx/aiying.error.log
```

---

## 🐛 常见问题

### Q1: sshpass命令未找到

**解决方案**: 安装sshpass工具

```bash
# macOS
brew install hudochenkov/sshpass/sshpass

# Linux
sudo apt-get install sshpass
```

### Q2: 权限被拒绝

**解决方案**: 赋予脚本执行权限

```bash
chmod +x *.sh
```

### Q3: Git推送失败

**解决方案**: 检查远程仓库配置和网络连接

```bash
# 查看远程仓库
git remote -v

# 测试连接
git fetch origin
```

### Q4: 服务器连接超时

**解决方案**:
1. 检查服务器IP和端口是否正确
2. 确认服务器防火墙允许SSH连接（22端口）
3. 验证用户名和密码

### Q5: 部署后500错误

**解决方案**:
1. 检查.env配置是否正确
2. 确认文件权限设置
3. 查看Laravel日志: `storage/logs/laravel.log`
4. 清理缓存: `php artisan cache:clear`

### Q6: Composer依赖安装失败

**解决方案**:
```bash
# 切换到国内镜像
composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/

# 或使用
composer config -g repo.packagist composer https://packagist.phpcomposer.com
```

---

## 📞 技术支持

如遇到其他问题，请检查：

1. **Laravel日志**: `storage/logs/laravel.log`
2. **Nginx日志**: `/var/log/nginx/aiying.error.log`
3. **服务器状态**: 运行 `./check-server.sh`

---

## 📝 更新日志

- **2025-12-22**: 创建所有部署脚本和文档

---

**祝部署顺利！🚀**
