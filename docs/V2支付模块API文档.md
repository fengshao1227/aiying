# V2 支付模块 API 文档

## 基础信息

- **Base URL**: `/v2`
- **Content-Type**: `application/json`
- **Accept**: `application/json`
- **认证方式**: 订单支付需要V2用户认证（中间件：`v2.user.auth`），支付回调无需认证

---

## 1. 商城订单支付

### 接口信息
- **URL**: `/v2/orders/mall/{id}/pay`
- **Method**: `POST`
- **认证**: 需要认证

### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | integer | 是 | 商城订单ID |

### 请求参数
无

### 请求示例
```
POST /v2/orders/mall/123/pay
```

### 响应格式
**成功响应 - 需要支付 (200)**:
```json
{
  "code": 0,
  "message": "获取支付参数成功",
  "data": {
    "appId": "wx1234567890abcdef",
    "timeStamp": "1703491200",
    "nonceStr": "abc123def456",
    "package": "prepay_id=wx20231225123456789",
    "signType": "RSA",
    "paySign": "base64_encoded_signature"
  }
}
```

**成功响应 - 纯积分支付 (200)**:
```json
{
  "code": 0,
  "message": "支付成功（纯积分）",
  "data": {
    "paid": true
  }
}
```

**订单不存在 (404)**:
```json
{
  "code": 404,
  "message": "订单不存在",
  "data": null
}
```

**订单状态不允许支付 (400)**:
```json
{
  "code": 400,
  "message": "订单状态不允许支付",
  "data": null
}
```

**未认证响应 (401)**:
```json
{
  "code": 401,
  "message": "用户未认证"
}
```

### 响应字段说明
| 字段 | 类型 | 说明 |
|------|------|------|
| `appId` | string | 小程序AppID |
| `timeStamp` | string | 时间戳（秒） |
| `nonceStr` | string | 随机字符串 |
| `package` | string | 预支付交易会话标识 |
| `signType` | string | 签名类型，固定为RSA |
| `paySign` | string | 签名 |
| `paid` | boolean | 纯积分支付时，表示已支付成功 |

### 业务说明
- 如果订单实付金额为0（纯积分支付），订单会立即标记为已支付，并发送企业微信通知
- 如果订单需要现金支付，返回微信支付参数供小程序调起支付
- 订单必须处于"待支付"状态才能发起支付

---

## 2. 订餐订单支付

### 接口信息
- **URL**: `/v2/orders/meal/{id}/pay`
- **Method**: `POST`
- **认证**: 需要认证

### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | integer | 是 | 订餐订单ID |

### 请求参数
无

### 请求示例
```
POST /v2/orders/meal/456/pay
```

### 响应格式
**成功响应 - 需要支付 (200)**:
```json
{
  "code": 0,
  "message": "获取支付参数成功",
  "data": {
    "appId": "wx1234567890abcdef",
    "timeStamp": "1703491200",
    "nonceStr": "abc123def456",
    "package": "prepay_id=wx20231225123456789",
    "signType": "RSA",
    "paySign": "base64_encoded_signature"
  }
}
```

**成功响应 - 纯积分支付 (200)**:
```json
{
  "code": 0,
  "message": "支付成功（纯积分）",
  "data": {
    "paid": true
  }
}
```

**订单不存在 (404)**:
```json
{
  "code": 404,
  "message": "订单不存在",
  "data": null
}
```

**订单状态不允许支付 (400)**:
```json
{
  "code": 400,
  "message": "订单状态不允许支付",
  "data": null
}
```

**未认证响应 (401)**:
```json
{
  "code": 401,
  "message": "用户未认证"
}
```

### 响应字段说明
同商城订单支付

### 业务说明
- 如果订单实付金额为0（纯积分支付），订单会立即标记为已支付，并发送企业微信通知
- 如果订单需要现金支付，返回微信支付参数供小程序调起支付
- 订单必须处于"待支付"状态才能发起支付

---

## 3. 微信支付回调

### 接口信息
- **URL**: `/v2/payments/notify`
- **Method**: `POST`
- **认证**: 无需认证（微信服务器回调）

### 请求头
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `Wechatpay-Timestamp` | string | 是 | 微信支付时间戳 |
| `Wechatpay-Nonce` | string | 是 | 微信支付随机串 |
| `Wechatpay-Signature` | string | 是 | 微信支付签名 |
| `Wechatpay-Serial` | string | 是 | 微信支付证书序列号 |

### 请求体
微信支付加密的回调数据（JSON格式）

### 响应格式
**成功响应 (200)**:
```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

**失败响应 (500)**:
```json
{
  "code": "FAIL",
  "message": "订单不存在"
}
```

### 业务说明
- 此接口由微信支付服务器调用，用于通知支付结果
- 系统会验证微信支付签名，确保回调来源可信
- 支持幂等性处理，重复回调不会重复处理
- 会验证订单金额与支付金额是否一致
- 支付成功后会自动发送企业微信通知
- 使用数据库事务和行锁确保并发安全

---

## 通用错误码

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误或业务逻辑错误 |
| 401 | 用户未认证 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 支付流程说明

### 小程序端支付流程
1. 用户创建订单后，调用支付接口获取支付参数
2. 如果是纯积分支付，直接返回支付成功
3. 如果需要现金支付，使用返回的参数调起微信支付
4. 微信支付完成后，微信服务器会回调通知接口
5. 系统处理回调，更新订单状态，发送通知

### 安全机制
- 所有支付请求都需要用户认证
- 支付回调会验证微信签名
- 使用数据库事务和行锁防止并发问题
- 验证订单金额与支付金额一致性
- 支持幂等性，防止重复处理

### 通知机制
- 支付成功后自动发送企业微信通知
- 通知在数据库事务外执行，避免阻塞
- 通知失败不影响支付流程，会记录错误日志
