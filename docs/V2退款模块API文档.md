# V2 退款模块 API 文档

## 基础信息

- **Base URL**: `/v2/orders`
- **Content-Type**: `application/json`
- **Accept**: `application/json`
- **认证方式**: 需要V2用户认证（中间件：`v2.user.auth`）

---

## 1. 申请商城订单退款

### 接口信息
- **URL**: `/v2/orders/mall/{id}/refund`
- **Method**: `POST`
- **认证**: 需要认证

### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | integer | 是 | 商城订单ID |

### 请求参数（Body）
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `reason` | string | 是 | 退款原因（最大200字符） |

### 请求示例
```json
POST /v2/orders/mall/123/refund
Content-Type: application/json

{
  "reason": "商品质量问题，需要退款"
}
```

### 响应格式
**成功响应 (200)**:
```json
{
  "code": 0,
  "message": "退款申请已提交",
  "data": {
    "id": 123,
    "order_no": "ORD20251225123456",
    "user_id": 10,
    "customer_id": 5,
    "total_amount": "299.00",
    "points_used": 100,
    "points_discount": "1.00",
    "actual_amount": "298.00",
    "payment_status": 1,
    "order_status": 1,
    "refund_status": 1,
    "refund_reason": "商品质量问题，需要退款",
    "paid_at": "2025-12-25T10:30:00.000000Z",
    "created_at": "2025-12-25T10:00:00.000000Z",
    "updated_at": "2025-12-25T11:00:00.000000Z"
  }
}
```

**订单不存在 (404)**:
```json
{
  "code": 404,
  "message": "订单不存在",
  "data": null
}
```

**订单状态不允许退款 (400)**:
```json
{
  "code": 400,
  "message": "当前订单状态不允许申请退款",
  "data": null
}
```

**参数验证失败 (400)**:
```json
{
  "code": 400,
  "message": "退款原因不能为空",
  "data": null
}
```

**未认证响应 (401)**:
```json
{
  "code": 401,
  "message": "用户未认证"
}
```

### 业务说明
- 只能对已支付或已发货的订单申请退款
- 订单必须未申请过退款（refund_status = 0）
- 申请提交后，订单状态变为"退款申请中"（refund_status = 1）
- 需要管理员审核通过后才会实际退款

---

## 2. 申请订餐订单退款

### 接口信息
- **URL**: `/v2/orders/meal/{id}/refund`
- **Method**: `POST`
- **认证**: 需要认证

### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | integer | 是 | 订餐订单ID |

### 请求参数（Body）
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `reason` | string | 是 | 退款原因（最大200字符） |

### 请求示例
```json
POST /v2/orders/meal/456/refund
Content-Type: application/json

{
  "reason": "临时有事，无法用餐"
}
```

### 响应格式
**成功响应 (200)**:
```json
{
  "code": 0,
  "message": "退款申请已提交",
  "data": {
    "id": 456,
    "order_no": "MEAL20251225123456",
    "user_id": 10,
    "customer_id": 5,
    "room_id": 101,
    "room_name": "201房间",
    "customer_name": "张三",
    "total_amount": "60.00",
    "points_used": 50,
    "points_discount": "0.50",
    "actual_amount": "59.50",
    "payment_status": 1,
    "order_status": 1,
    "refund_status": 1,
    "refund_reason": "临时有事，无法用餐",
    "paid_at": "2025-12-25T08:00:00.000000Z",
    "created_at": "2025-12-25T07:30:00.000000Z",
    "updated_at": "2025-12-25T09:00:00.000000Z"
  }
}
```

**订单不存在 (404)**:
```json
{
  "code": 404,
  "message": "订单不存在",
  "data": null
}
```

**订单状态不允许退款 (400)**:
```json
{
  "code": 400,
  "message": "当前订单状态不允许申请退款",
  "data": null
}
```

**参数验证失败 (400)**:
```json
{
  "code": 400,
  "message": "退款原因不能为空",
  "data": null
}
```

**未认证响应 (401)**:
```json
{
  "code": 401,
  "message": "用户未认证"
}
```

### 业务说明
- 只能对已支付的订餐订单申请退款
- 订单必须未申请过退款（refund_status = 0）
- 申请提交后，订单状态变为"退款申请中"（refund_status = 1）
- 需要管理员审核通过后才会实际退款

---

## 退款状态说明

### 商城订单退款状态
| 状态值 | 常量名 | 说明 |
|--------|--------|------|
| 0 | REFUND_NONE | 无退款 |
| 1 | REFUND_APPLYING | 退款申请中 |
| 2 | REFUND_SUCCESS | 退款成功 |
| 3 | REFUND_REJECTED | 退款被拒绝 |

### 订餐订单退款状态
| 状态值 | 说明 |
|--------|------|
| 0 | 无退款 |
| 1 | 退款申请中 |
| 2 | 退款成功 |
| 3 | 退款被拒绝 |

---

## 退款流程说明

### 用户端流程
1. 用户在订单详情页点击"申请退款"
2. 填写退款原因并提交
3. 系统记录退款申请，订单状态变为"退款申请中"
4. 等待管理员审核
5. 审核通过后，系统自动处理退款

### 退款处理逻辑（管理员审核通过后）

#### 商城订单退款
1. **现金退款**：
   - 如果订单有现金支付（actual_amount > 0），调用微信退款API
   - 退款金额原路返回到用户微信账户
   - 纯积分支付的订单（transaction_id以"POINTS_ONLY_"开头）不调用微信退款

2. **积分退还**：
   - 如果订单使用了积分（points_used > 0），退还积分到用户账户
   - 记录积分变动历史

3. **库存恢复**：
   - 恢复订单中所有商品的库存
   - 使用数据库事务确保数据一致性

4. **订单状态更新**：
   - refund_status = 2（退款成功）
   - order_status = 3（已取消）
   - 记录退款金额、退款积分、退款时间

#### 订餐订单退款
1. **积分退还**：
   - 如果订单使用了积分，退还到用户账户
   - 记录积分变动历史

2. **订单状态更新**：
   - refund_status = 2（退款成功）
   - order_status = 3（已取消）
   - 记录退款时间

**注意**：订餐订单目前不支持现金退款（业务规则限制）

---

## 退款限制条件

### 商城订单可退款条件
- 订单已支付（payment_status = 1）
- 订单状态为"已支付"或"已发货"（order_status = 1 或 2）
- 未申请过退款（refund_status = 0）
- 订单属于当前用户

### 订餐订单可退款条件
- 订单已支付（payment_status = 1）
- 订单状态为"已支付"（order_status = 1）
- 未申请过退款（refund_status = 0）
- 订单属于当前用户

---

## 通用错误码

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误或业务逻辑错误 |
| 401 | 用户未认证 |
| 404 | 订单不存在 |
| 500 | 服务器内部错误 |

---

## 安全机制

### 权限控制
- 用户只能对自己的订单申请退款
- 所有接口都需要用户认证
- 订单归属验证通过 `forUser()` scope 实现

### 数据一致性
- 使用数据库事务确保退款操作的原子性
- 使用行锁（lockForUpdate）防止并发问题
- 退款前进行二次状态校验（lock-in-lock validation）

### 幂等性保护
- 同一订单不能重复申请退款
- 退款状态机制防止重复处理

---

## 注意事项

### 退款时效
- 微信退款通常即时到账，最长不超过3个工作日
- 积分退还立即到账

### 退款金额
- 退款金额为订单实付金额（actual_amount）
- 积分抵扣部分以积分形式退还

### 审核机制
- 所有退款申请需要管理员审核
- 管理员可以通过或拒绝退款申请
- 拒绝时需要填写拒绝原因

### 特殊情况
- 纯积分支付的订单不会调用微信退款API
- 订餐订单目前不支持现金退款（业务规则）
- 退款失败会记录错误日志，需要人工介入处理
