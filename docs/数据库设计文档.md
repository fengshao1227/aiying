# 瑷婴月子中心 - 数据库设计文档

> 版本：v2.0（重构版）
> 更新日期：2025-12-24
> 状态：设计完成

---

## 一、设计原则

1. **从零设计**：不依赖现有表结构，完全按需求重新设计
2. **职责分离**：商城订单与订餐订单独立，避免混淆
3. **统一命名**：主键 `id`，外键 `表名_id`，时间戳 `xxx_at`
4. **完整追踪**：积分变动、订单状态全程记录
5. **灵活配置**：系统参数可配置，避免硬编码

---

## 二、表结构总览

### 2.1 表清单

| 模块 | 表名 | 说明 | 状态 |
|------|------|------|------|
| **用户体系** | `users` | 小程序用户 | 新设计 |
| **商品系统** | `categories` | 商品分类 | 新设计 |
| | `products` | 商品信息 | 新设计 |
| **商城订单** | `orders` | 商城订单主表 | 新设计 |
| | `order_items` | 商城订单明细 | 新设计 |
| **订餐系统** | `meal_configs` | 订餐配置 | 新设计 |
| | `meal_orders` | 订餐订单主表 | 新设计 |
| | `meal_order_items` | 订餐订单明细 | 新设计 |
| **积分系统** | `points_history` | 积分变动记录 | 新设计 |
| **系统配置** | `system_configs` | 系统配置 | 新设计 |
| | `notification_logs` | 通知日志 | 新设计 |
| **购物车** | `carts` | 购物车 | 新设计 |
| **月子中心** | `customers` | 客户档案 | 保留 |
| | `rooms` | 房间信息 | 保留 |
| | `room_status` | 房态记录 | 保留 |
| | `admins` | 管理员 | 保留 |
| | `score_card_records` | 评分卡记录 | 保留 |

### 2.2 表关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        月子中心管理（保留）                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────────┐              │
│  │ customers│◄───│room_status│───►│    rooms     │              │
│  └────┬─────┘    └──────────┘    └──────────────┘              │
│       │                                                         │
│       │          ┌──────────────────┐                          │
│       └─────────►│score_card_records│                          │
│                  └──────────────────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        小程序业务（新设计）                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐  bindTo   ┌──────────┐                           │
│  │  users   │──────────►│ customers│                           │
│  └────┬─────┘           └──────────┘                           │
│       │                                                         │
│       │ hasMany                                                 │
│       ├─────────────────────────────┐                          │
│       │                             │                          │
│       ▼                             ▼                          │
│  ┌──────────┐                 ┌─────────────┐                  │
│  │  orders  │                 │ meal_orders │                  │
│  │ (商城)   │                 │  (订餐)     │                  │
│  └────┬─────┘                 └──────┬──────┘                  │
│       │                              │                          │
│       │ hasMany                      │ hasMany                  │
│       ▼                              ▼                          │
│  ┌──────────────┐            ┌──────────────────┐              │
│  │ order_items  │            │ meal_order_items │              │
│  └──────┬───────┘            └──────────────────┘              │
│         │                                                       │
│         │ belongsTo                                             │
│         ▼                                                       │
│  ┌──────────┐    belongsTo   ┌────────────┐                    │
│  │ products │───────────────►│ categories │                    │
│  └──────────┘                └────────────┘                    │
│                                                                 │
│  ┌────────────────┐          ┌──────────┐                      │
│  │ points_history │◄─────────│  users   │                      │
│  └────────────────┘          └──────────┘                      │
│                                                                 │
│  ┌──────────┐                                                   │
│  │  carts   │◄─── users (购物车)                                │
│  └──────────┘                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                        系统配置                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────┐    ┌──────────────┐    ┌─────────────────┐ │
│  │ system_configs │    │ meal_configs │    │notification_logs│ │
│  └────────────────┘    └──────────────┘    └─────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、表结构详细设计

### 3.1 users - 小程序用户表

> 微信小程序登录的用户，可通过手机号绑定到月子中心客户

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 用户ID |
| `openid` | varchar(64) | 是 | - | 微信openid |
| `unionid` | varchar(64) | 否 | NULL | 微信unionid（预留） |
| `customer_id` | bigint unsigned | 否 | NULL | 绑定的客户ID |
| `bind_phone` | varchar(20) | 否 | NULL | 绑定的月子中心登记手机号 |
| `nickname` | varchar(64) | 否 | NULL | 微信昵称 |
| `avatar` | varchar(512) | 否 | NULL | 头像URL |
| `gender` | tinyint unsigned | 否 | 0 | 性别：0=未知，1=男，2=女 |
| `phone` | varchar(20) | 否 | NULL | 微信绑定手机号 |
| `points_balance` | int unsigned | 是 | 0 | 积分余额 |
| `status` | tinyint unsigned | 是 | 1 | 状态：0=禁用，1=正常 |
| `last_login_at` | timestamp | 否 | NULL | 最后登录时间 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |
| `deleted_at` | timestamp | 否 | NULL | 软删除时间 |

**索引：**
- `uk_openid` - openid 唯一索引
- `uk_bind_phone` - 绑定手机号唯一索引
- `idx_customer_id` - 客户ID索引

**绑定逻辑：**
1. 用户填写月子中心登记手机号
2. 系统在 `customers` 表查找匹配手机号
3. 匹配成功：设置 `customer_id` 和 `bind_phone`
4. 匹配失败：提示用户联系前台

---

### 3.2 categories - 商品分类表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 分类ID |
| `name` | varchar(50) | 是 | - | 分类名称 |
| `icon` | varchar(512) | 否 | NULL | 分类图标 |
| `sort_order` | int | 是 | 0 | 排序（越大越靠前） |
| `status` | tinyint unsigned | 是 | 1 | 状态：0=禁用，1=启用 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |
| `deleted_at` | timestamp | 否 | NULL | 软删除时间 |

---

### 3.3 products - 商品表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 商品ID |
| `category_id` | bigint unsigned | 是 | - | 分类ID |
| `name` | varchar(128) | 是 | - | 商品名称 |
| `cover_image` | varchar(512) | 是 | - | 商品主图 |
| `images` | json | 否 | NULL | 商品图片列表 |
| `delivery_type` | enum | 是 | 'express' | 配送类型：express=快递，room=送到房间 |
| `original_price` | decimal(10,2) | 否 | NULL | 原价（划线价） |
| `price` | decimal(10,2) | 是 | - | 现金价格 |
| `points_price` | int unsigned | 否 | NULL | 积分价格（null=不支持积分） |
| `stock` | int unsigned | 是 | 0 | 库存 |
| `sales` | int unsigned | 是 | 0 | 销量 |
| `unit` | varchar(20) | 否 | '件' | 单位 |
| `summary` | varchar(255) | 否 | NULL | 商品简介 |
| `description` | text | 否 | NULL | 商品详情（富文本） |
| `sort_order` | int | 是 | 0 | 排序（越大越靠前） |
| `status` | tinyint unsigned | 是 | 1 | 状态：0=下架，1=上架 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |
| `deleted_at` | timestamp | 否 | NULL | 软删除时间 |

**支付方式说明：**
- `price` > 0 且 `points_price` = NULL：仅支持现金购买
- `price` > 0 且 `points_price` > 0：支持现金或积分二选一
- `price` = 0 且 `points_price` > 0：仅支持积分兑换

---

### 3.4 orders - 商城订单表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 订单ID |
| `order_no` | varchar(32) | 是 | - | 订单号 |
| `user_id` | bigint unsigned | 是 | - | 用户ID |
| `customer_id` | bigint unsigned | 否 | NULL | 客户ID |
| **配送信息** |
| `delivery_type` | enum | 是 | 'express' | 配送类型 |
| `room_id` | bigint unsigned | 否 | NULL | 房间ID（房间配送） |
| `room_name` | varchar(50) | 否 | NULL | 房间名称（冗余） |
| `receiver_name` | varchar(50) | 否 | NULL | 收货人姓名（快递） |
| `receiver_phone` | varchar(20) | 否 | NULL | 收货人电话（快递） |
| `receiver_address` | varchar(255) | 否 | NULL | 收货地址（快递） |
| **金额信息** |
| `total_amount` | decimal(10,2) | 是 | - | 商品总金额 |
| `freight_amount` | decimal(10,2) | 是 | 0.00 | 运费 |
| `points_used` | int unsigned | 是 | 0 | 使用积分 |
| `points_discount` | decimal(10,2) | 是 | 0.00 | 积分抵扣金额 |
| `actual_amount` | decimal(10,2) | 是 | - | 实付金额 |
| **支付信息** |
| `payment_type` | enum | 是 | 'cash' | 支付类型：cash/points/mixed |
| `payment_status` | tinyint unsigned | 是 | 0 | 支付状态：0=未支付，1=已支付 |
| `transaction_id` | varchar(64) | 否 | NULL | 微信支付交易号 |
| `paid_at` | timestamp | 否 | NULL | 支付时间 |
| **订单状态** |
| `order_status` | tinyint unsigned | 是 | 0 | 订单状态（见下表） |
| `shipping_no` | varchar(64) | 否 | NULL | 快递单号 |
| `shipping_company` | varchar(50) | 否 | NULL | 快递公司 |
| `shipped_at` | timestamp | 否 | NULL | 发货时间 |
| `completed_at` | timestamp | 否 | NULL | 完成时间 |
| `cancelled_at` | timestamp | 否 | NULL | 取消时间 |
| `cancel_reason` | varchar(255) | 否 | NULL | 取消原因 |
| **退款信息** |
| `refund_status` | tinyint unsigned | 是 | 0 | 退款状态（见下表） |
| `refund_reason` | varchar(255) | 否 | NULL | 退款原因 |
| `refund_amount` | decimal(10,2) | 否 | NULL | 退款金额 |
| `refund_points` | int unsigned | 否 | NULL | 退还积分 |
| `refund_at` | timestamp | 否 | NULL | 退款时间 |
| **其他** |
| `remarks` | varchar(255) | 否 | NULL | 订单备注 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |
| `deleted_at` | timestamp | 否 | NULL | 软删除时间 |

**订单状态 `order_status`：**
| 值 | 状态 | 说明 |
|----|------|------|
| 0 | 待支付 | 订单创建，等待支付 |
| 1 | 待发货 | 已支付，等待发货（快递商品） |
| 2 | 已发货 | 已发货，等待收货（快递商品） |
| 3 | 已完成 | 订单完成 |
| 4 | 已取消 | 订单取消 |

**退款状态 `refund_status`：**
| 值 | 状态 | 说明 |
|----|------|------|
| 0 | 无 | 未申请退款 |
| 1 | 申请中 | 已申请，等待审核 |
| 2 | 已退款 | 退款成功 |
| 3 | 已拒绝 | 退款被拒绝 |

**状态流转：**
```
快递商品：待支付 → 待发货 → 已发货 → 已完成
                ↘ 已取消

房间商品：待支付 → 待发货 → 已完成（无需发货流程，直接完成）
                ↘ 已取消
```

---

### 3.5 order_items - 商城订单明细表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 明细ID |
| `order_id` | bigint unsigned | 是 | - | 订单ID |
| `product_id` | bigint unsigned | 是 | - | 商品ID |
| `product_name` | varchar(128) | 是 | - | 商品名称（冗余） |
| `product_image` | varchar(512) | 是 | - | 商品图片（冗余） |
| `price` | decimal(10,2) | 是 | - | 商品单价 |
| `quantity` | int unsigned | 是 | 1 | 数量 |
| `subtotal` | decimal(10,2) | 是 | - | 小计金额 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |

---

### 3.6 meal_configs - 订餐配置表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 配置ID |
| `meal_type` | enum | 是 | - | 餐次类型：breakfast/lunch/dinner |
| `name` | varchar(20) | 是 | - | 餐次名称 |
| `price` | decimal(10,2) | 是 | - | 单价 |
| `order_start_time` | time | 否 | NULL | 可订餐开始时间 |
| `order_end_time` | time | 否 | NULL | 可订餐截止时间 |
| `advance_days` | tinyint unsigned | 是 | 0 | 需提前几天订餐 |
| `description` | varchar(255) | 否 | NULL | 描述说明 |
| `status` | tinyint unsigned | 是 | 1 | 状态：0=禁用，1=启用 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |

**默认配置：**
| 餐次 | 名称 | 价格 | 截止时间 | 提前天数 |
|------|------|------|---------|---------|
| breakfast | 早餐 | ¥15.00 | 前一天 20:00 | 1 |
| lunch | 午餐 | ¥25.00 | 当天 09:00 | 0 |
| dinner | 晚餐 | ¥25.00 | 当天 14:00 | 0 |

---

### 3.7 meal_orders - 订餐订单表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 订单ID |
| `order_no` | varchar(32) | 是 | - | 订单号 |
| `user_id` | bigint unsigned | 是 | - | 用户ID |
| `customer_id` | bigint unsigned | 是 | - | 客户ID |
| `room_id` | bigint unsigned | 否 | NULL | 房间ID |
| `room_name` | varchar(50) | 是 | - | 房间名称（冗余） |
| `customer_name` | varchar(50) | 否 | NULL | 客户姓名（冗余） |
| **金额信息** |
| `total_amount` | decimal(10,2) | 是 | - | 订单总金额 |
| `points_used` | int unsigned | 是 | 0 | 使用积分 |
| `points_discount` | decimal(10,2) | 是 | 0.00 | 积分抵扣金额 |
| `actual_amount` | decimal(10,2) | 是 | - | 实付金额 |
| **支付信息** |
| `payment_type` | enum | 是 | 'cash' | 支付类型：cash/points/mixed |
| `payment_status` | tinyint unsigned | 是 | 0 | 支付状态：0=未支付，1=已支付 |
| `transaction_id` | varchar(64) | 否 | NULL | 微信支付交易号 |
| `paid_at` | timestamp | 否 | NULL | 支付时间 |
| **订单状态** |
| `order_status` | tinyint unsigned | 是 | 0 | 订单状态（见下表） |
| `completed_at` | timestamp | 否 | NULL | 完成时间 |
| `cancelled_at` | timestamp | 否 | NULL | 取消时间 |
| `cancel_reason` | varchar(255) | 否 | NULL | 取消原因 |
| **其他** |
| `remarks` | varchar(255) | 否 | NULL | 备注 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |
| `deleted_at` | timestamp | 否 | NULL | 软删除时间 |

**订单状态 `order_status`：**
| 值 | 状态 | 说明 |
|----|------|------|
| 0 | 待支付 | 订单创建，等待支付 |
| 1 | 已支付 | 已支付，等待配送 |
| 2 | 已完成 | 所有餐次已配送完成 |
| 3 | 已取消 | 订单取消 |

---

### 3.8 meal_order_items - 订餐订单明细表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 明细ID |
| `meal_order_id` | bigint unsigned | 是 | - | 订餐订单ID |
| `meal_date` | date | 是 | - | 用餐日期 |
| `meal_type` | enum | 是 | - | 餐次类型 |
| `meal_name` | varchar(20) | 是 | - | 餐次名称（冗余） |
| `quantity` | int unsigned | 是 | 1 | 份数 |
| `unit_price` | decimal(10,2) | 是 | - | 单价 |
| `subtotal` | decimal(10,2) | 是 | - | 小计 |
| `delivery_status` | tinyint unsigned | 是 | 0 | 配送状态：0=待配送，1=已配送 |
| `delivered_at` | timestamp | 否 | NULL | 配送时间 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |

**索引设计：**
- `idx_meal_date` - 用餐日期索引（统计查询）
- `idx_date_type` - 日期+餐次复合索引（每日统计）

**示例数据：**
```
订单：2025-12-25 ~ 2025-12-27，每天午餐2份、晚餐1份

meal_order_items:
| meal_date  | meal_type | quantity | unit_price | subtotal |
|------------|-----------|----------|------------|----------|
| 2025-12-25 | lunch     | 2        | 25.00      | 50.00    |
| 2025-12-25 | dinner    | 1        | 25.00      | 25.00    |
| 2025-12-26 | lunch     | 2        | 25.00      | 50.00    |
| 2025-12-26 | dinner    | 1        | 25.00      | 25.00    |
| 2025-12-27 | lunch     | 2        | 25.00      | 50.00    |
| 2025-12-27 | dinner    | 1        | 25.00      | 25.00    |

订单总金额：225.00
```

---

### 3.9 points_history - 积分变动记录表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 记录ID |
| `user_id` | bigint unsigned | 是 | - | 用户ID |
| `customer_id` | bigint unsigned | 否 | NULL | 客户ID |
| `type` | enum | 是 | - | 变动类型（见下表） |
| `points` | int | 是 | - | 变动积分（正=增加，负=减少） |
| `balance_before` | int unsigned | 是 | - | 变动前余额 |
| `balance_after` | int unsigned | 是 | - | 变动后余额 |
| `source` | varchar(50) | 否 | NULL | 来源：order/meal/admin |
| `source_id` | bigint unsigned | 否 | NULL | 来源ID |
| `description` | varchar(255) | 否 | NULL | 变动描述 |
| `operator_id` | bigint unsigned | 否 | NULL | 操作人ID |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |

**变动类型 `type`：**
| 值 | 类型 | 说明 |
|----|------|------|
| earn | 获取 | 消费返积分、活动赠送等 |
| spend | 消费 | 商城购买、订餐抵扣 |
| refund | 退还 | 订单退款退还积分 |
| admin_add | 后台充值 | 管理员手动充值 |
| admin_deduct | 后台扣除 | 管理员手动扣除 |

---

### 3.10 system_configs - 系统配置表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 配置ID |
| `config_key` | varchar(64) | 是 | - | 配置键 |
| `config_value` | text | 否 | NULL | 配置值 |
| `config_type` | enum | 是 | 'string' | 值类型：string/number/boolean/json |
| `group` | varchar(50) | 否 | 'general' | 配置分组 |
| `description` | varchar(255) | 否 | NULL | 配置说明 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |

**默认配置：**
| 配置键 | 值 | 类型 | 分组 | 说明 |
|--------|-----|------|------|------|
| `points_exchange_rate` | 100 | number | points | 积分兑换比例（100积分=1元） |
| `points_max_discount_rate` | 50 | number | points | 最大抵扣比例（%） |
| `order_cancel_minutes` | 30 | number | order | 自动取消时间（分钟） |
| `order_auto_complete_days` | 7 | number | order | 自动完成天数 |
| `wechat_robot_webhook` | - | string | notification | 企微机器人地址 |
| `daily_report_time` | 20:00 | string | notification | 每日统计时间 |
| `notify_new_meal_order` | true | boolean | notification | 新订餐订单通知 |
| `notify_new_goods_order` | true | boolean | notification | 新商城订单通知 |

---

### 3.11 notification_logs - 通知日志表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 日志ID |
| `type` | varchar(50) | 是 | - | 通知类型 |
| `channel` | varchar(50) | 是 | 'wechat_robot' | 通知渠道 |
| `title` | varchar(128) | 否 | NULL | 通知标题 |
| `content` | text | 是 | - | 通知内容 |
| `related_id` | bigint unsigned | 否 | NULL | 关联ID |
| `status` | tinyint unsigned | 是 | 0 | 状态：0=待发送，1=已发送，2=失败 |
| `error_message` | varchar(255) | 否 | NULL | 错误信息 |
| `sent_at` | timestamp | 否 | NULL | 发送时间 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |

**通知类型 `type`：**
- `new_meal_order` - 新订餐订单
- `daily_meal_report` - 每日订餐统计
- `new_goods_order` - 新商城订单

---

### 3.12 carts - 购物车表

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `id` | bigint unsigned | 是 | AUTO | 购物车ID |
| `user_id` | bigint unsigned | 是 | - | 用户ID |
| `product_id` | bigint unsigned | 是 | - | 商品ID |
| `quantity` | int unsigned | 是 | 1 | 数量 |
| `selected` | tinyint unsigned | 是 | 1 | 是否选中 |
| `created_at` | timestamp | 是 | CURRENT | 创建时间 |
| `updated_at` | timestamp | 是 | CURRENT | 更新时间 |

**约束：**
- `uk_user_product` - 用户+商品唯一约束（同一商品只能有一条记录）

---

## 四、核心业务流程

### 4.1 用户绑定流程

```
用户微信登录
    ↓
创建 users 记录（openid）
    ↓
用户填写月子中心登记手机号
    ↓
系统查询 customers 表
    ↓
┌─────────────────┬─────────────────┐
│   匹配成功       │   匹配失败       │
├─────────────────┼─────────────────┤
│ 设置 customer_id │ 提示联系前台     │
│ 设置 bind_phone  │                 │
│ 获得全部权限      │ 仅可浏览商品     │
└─────────────────┴─────────────────┘
```

### 4.2 商城订单流程

```
用户选购商品 → 加入购物车
    ↓
结算（选择配送方式）
    ↓
┌──────────────┬──────────────┐
│  快递配送     │  房间配送     │
├──────────────┼──────────────┤
│ 填写收货地址   │ 自动获取房间   │
└──────────────┴──────────────┘
    ↓
选择支付方式（现金/积分）
    ↓
创建订单 → 支付
    ↓
┌──────────────┬──────────────┐
│  快递配送     │  房间配送     │
├──────────────┼──────────────┤
│ 待发货        │ 待发货        │
│   ↓          │   ↓          │
│ 已发货        │ 已完成        │
│   ↓          │              │
│ 已完成        │              │
└──────────────┴──────────────┘
```

### 4.3 订餐订单流程

```
用户选择日期（可多选）
    ↓
选择餐次和份数
┌────────────────────┐
│ 12月25日           │
│  - 早餐 × 0        │
│  - 午餐 × 2        │
│  - 晚餐 × 1        │
├────────────────────┤
│ 12月26日           │
│  - 早餐 × 1        │
│  - 午餐 × 2        │
│  - 晚餐 × 1        │
└────────────────────┘
    ↓
计算总价
    ↓
选择支付方式（微信/积分+微信）
    ↓
创建订单（meal_orders + meal_order_items）
    ↓
支付 → 通知企业微信
    ↓
按日期+餐次配送 → 标记已配送
    ↓
全部配送完成 → 订单完成
```

### 4.4 积分抵扣计算

```python
# 示例：订单金额 100 元，用户积分 800

points_exchange_rate = 100          # 100积分=1元
points_max_discount_rate = 50       # 最大抵扣50%

order_amount = 100.00               # 订单金额
user_points = 800                   # 用户积分

# 计算最大可抵扣金额
max_discount = order_amount * (points_max_discount_rate / 100)  # 50.00

# 计算积分可抵扣金额
points_value = user_points / points_exchange_rate  # 8.00

# 实际抵扣（取较小值）
actual_discount = min(max_discount, points_value)  # 8.00
points_used = actual_discount * points_exchange_rate  # 800

# 实付金额
actual_amount = order_amount - actual_discount  # 92.00
```

---

## 五、SQL 文件

完整的建表 SQL 文件位于：`/docs/sql/schema_v2.sql`

---

## 六、待办事项

| 序号 | 事项 | 状态 |
|------|------|------|
| 1 | 确认积分兑换比例默认值（当前：100:1） | 待确认 |
| 2 | 确认餐次价格默认值（当前：早15/午晚25） | 待确认 |
| 3 | 确认是否需要购物车功能 | 待确认 |
| 4 | 旧数据迁移方案 | 待设计 |
