# 瑷婴月子中心小程序 - 产品需求文档

> 版本：v2.0（重构版）
> 更新日期：2025-12-23
> 状态：需求梳理完成，待技术方案设计

---

## 一、产品概述

### 1.1 产品定位
瑷婴月子中心小程序是面向月子中心入住客户及其家属的服务平台，核心功能包括：
- **家属订餐**：为入住客户的家属提供陪护餐订购服务
- **积分商城**：通过积分兑换或购买母婴用品、护理产品等

### 1.2 目标用户
| 用户类型 | 描述 |
|---------|------|
| 入住客户 | 月子中心的宝妈，已在后台登记信息 |
| 家属 | 入住客户的家人，共用客户账号使用小程序 |

---

## 二、用户体系

### 2.1 双表关联设计

```
┌─────────────────┐         ┌─────────────────┐
│     users       │         │   customers     │
│  (小程序用户)    │bindTo   │  (月子中心客户)  │
│                 │────────▶│                 │
│ - openid        │         │ - customer_id   │
│ - phone         │         │ - phone         │
│ - customer_id   │         │ - room (房间)    │
└─────────────────┘         └─────────────────┘
      ▲                            ▲
      │ 微信登录自动创建             │ 后台手动录入
```

### 2.2 绑定流程

1. 用户微信登录小程序 → 自动创建 `users` 记录
2. 用户在小程序填写"月子中心登记手机号"
3. 系统查找 `customers` 表匹配该手机号
4. **匹配成功** → 建立关联（`users.customer_id = customers.customer_id`）
5. **匹配失败** → 提示"未找到记录，请联系前台确认"

### 2.3 绑定规则

| 规则项 | 说明 |
|-------|------|
| 验证方式 | 无需验证码，直接绑定（信任用户） |
| 绑定关系 | 一个 user 只能绑定一个 customer |
| 家属使用 | 家属共用入住客户的微信账号 |

### 2.4 功能权限

| 功能 | 未绑定用户 | 已绑定用户 |
|------|-----------|-----------|
| 浏览商品 | ✓ | ✓ |
| 购买商品 | ✗ | ✓ |
| 家属订餐 | ✗ | ✓ |
| 使用积分 | ✗ | ✓ |

---

## 三、积分系统

### 3.1 积分获取方式（预留扩展）

| 方式 | 说明 | 优先级 |
|------|------|-------|
| 后台手动充值/赠送 | 管理员在后台为客户充值积分 | P0 |
| 入住自动赠送 | 客户入住时自动赠送一定数量积分 | P1 |
| 消费返积分 | 订餐、购物等消费后返还积分 | P2 |

### 3.2 积分使用场景

| 场景 | 使用方式 |
|------|---------|
| 积分商城 | 纯积分兑换商品 |
| 家属订餐 | 积分抵扣部分金额（积分+现金混合支付） |

### 3.3 积分配置

| 配置项 | 说明 |
|-------|------|
| 兑换比例 | 后台可配置，如 100积分 = 1元 |
| 抵扣上限 | 可配置单笔订单最大抵扣比例 |

---

## 四、家属订餐

### 4.1 业务流程

```
选择日期（可多选）
    ↓
选择餐次和份数
  - 早餐：X份
  - 午餐：X份
  - 晚餐：X份
    ↓
计算总价
    ↓
选择支付方式
  - 微信支付
  - 积分抵扣 + 微信支付
    ↓
提交订单 → 支付
    ↓
送餐到绑定客户房间
```

### 4.2 订餐规则

| 规则项 | 说明 |
|-------|------|
| 餐品类型 | 陪护餐（统一） |
| 可选日期 | 支持多天同时订购 |
| 餐次选择 | 早餐、午餐、晚餐，各自独立选份数 |
| 送餐地址 | 自动送到绑定客户的房间 |
| 时间限制 | 后台可配置（如早餐需前一天晚上订） |

### 4.3 后台配置项

| 配置项 | 说明 |
|-------|------|
| 餐品价格 | 早/中/晚餐各自的单价 |
| 订餐时间段 | 各餐次的可订购时间范围 |
| 提前预订时间 | 需要提前多久订餐 |

### 4.4 订单状态

```
待支付 ──▶ 已支付 ──▶ 已完成
   │
   └──▶ 已取消（用户取消/超时取消）
```

### 4.5 统计与通知

| 功能 | 说明 |
|------|------|
| 实时通知 | 新订单通过企业微信机器人通知（客户、房间、餐次、份数、日期） |
| 每日统计 | 每天晚上统计第二天的订餐总数，推送到企业微信 |
| 后台报表 | 按日期、房间等维度查看详细订餐数据 |

---

## 五、积分商城

### 5.1 商品类型

| 类型 | 配送方式 | 收货信息 | 订单状态 |
|------|---------|---------|---------|
| 快递商品 | 快递配送 | 收货地址 | 待支付→待发货→已发货→已收货 |
| 房间商品 | 送到房间 | 房间号 | 待支付→已支付→已完成 |

### 5.2 商品字段设计

| 字段 | 说明 |
|------|------|
| `delivery_type` | 配送类型：`express`(快递) / `room`(房间) |
| `price` | 现金价格（设置较高，鼓励用积分） |
| `points_price` | 积分价格 |

### 5.3 支付方式

用户下单时可选择：
- **纯积分兑换**：使用积分价格
- **现金购买**：使用现金价格（微信支付）

### 5.4 购买限制

| 限制项 | 说明 |
|-------|------|
| 购买资格 | 仅已绑定用户可购买 |
| 库存检查 | 下单时检查库存 |

---

## 六、订单管理

### 6.1 订单类型

| 类型 | 来源 | 标识 |
|------|------|------|
| 商城订单 | 积分商城购买 | `order_type = 'goods'` |
| 订餐订单 | 家属订餐 | `order_type = 'family_meal'` |

### 6.2 取消规则

| 规则 | 说明 |
|------|------|
| 手动取消 | 用户可在支付前手动取消 |
| 自动取消 | 30分钟未支付自动取消 |

### 6.3 退款流程

```
用户申请退款
    ↓
后台人工审核
    ↓
审核通过 → 原路退回（微信退款 + 积分退回）
审核拒绝 → 通知用户
```

---

## 七、通知系统

### 7.1 企业微信机器人通知

| 通知场景 | 通知内容 | 接收方 |
|---------|---------|-------|
| 新订餐订单 | 客户、房间、餐次、份数、日期 | 后台管理员 |
| 每日订餐统计 | 第二天早/中/晚餐总份数 | 后台管理员 |

### 7.2 后台配置

| 配置项 | 说明 |
|-------|------|
| Webhook 地址 | 企业微信机器人地址 |
| 通知模板 | 可自定义通知内容格式 |
| 统计推送时间 | 每日统计的推送时间（如每天 20:00） |

---

## 八、后台管理模块

### 8.1 月子中心管理（保持现有）

| 模块 | 功能 |
|------|------|
| 客户管理 | 客户信息 CRUD |
| 房间管理 | 房间信息 CRUD |
| 房态管理 | 入住/退房/房态查看 |
| 评分卡管理 | 客户评分记录 |

### 8.2 商城管理

| 模块 | 功能 |
|------|------|
| 商品管理 | 商品 CRUD、上下架、库存管理 |
| 分类管理 | 商品分类 CRUD |
| 订单管理 | 订单列表、发货、退款审核 |

### 8.3 订餐管理

| 模块 | 功能 |
|------|------|
| 订餐订单 | 订单列表、确认完成 |
| 订餐统计 | 按日期/房间统计报表 |
| 餐品配置 | 价格、时间段配置 |

### 8.4 积分管理

| 模块 | 功能 |
|------|------|
| 积分充值 | 为客户手动充值积分 |
| 积分记录 | 查看积分变动历史 |
| 积分配置 | 兑换比例等配置 |

### 8.5 系统配置

| 模块 | 功能 |
|------|------|
| 通知配置 | 企业微信机器人配置 |
| 基础配置 | 积分比例、订单超时时间等 |

---

## 九、数据表设计（概要）

### 9.1 需要新增/修改的表

| 表名 | 说明 | 操作 |
|------|------|------|
| `users` | 添加 `customer_id` 字段 | 修改 |
| `products` | 添加 `delivery_type`, `points_price` 字段 | 修改 |
| `orders` | 统一订单表，区分类型 | 修改 |
| `system_configs` | 系统配置表 | 新增 |
| `meal_configs` | 订餐配置表 | 新增 |
| `points_history` | 积分变动记录 | 保留/优化 |

### 9.2 表关系图

```
users ──bindTo──▶ customers ──hasMany──▶ room_status ──belongsTo──▶ rooms
  │
  └──hasMany──▶ orders ──hasMany──▶ order_items
  │
  └──hasMany──▶ points_history
```

---

## 十、开发优先级

### P0 - 核心功能（必须）

1. 用户绑定机制
2. 家属订餐（含支付）
3. 订餐统计与通知
4. 积分后台充值

### P1 - 重要功能

1. 积分商城基础功能
2. 订单管理（取消/退款）
3. 后台配置功能

### P2 - 扩展功能

1. 积分自动获取（入住赠送、消费返积分）
2. 更多统计报表
3. 消息通知优化

---

## 十一、待确认事项

| 序号 | 问题 | 状态 |
|------|------|------|
| 1 | 积分兑换比例的具体数值 | 待定 |
| 2 | 订餐时间段的具体配置 | 待定 |
| 3 | 每日统计推送的具体时间 | 待定 |

---

## 附录：术语表

| 术语 | 说明 |
|------|------|
| 入住客户 | 在月子中心入住的宝妈，信息存储在 `customers` 表 |
| 小程序用户 | 通过微信登录小程序的用户，信息存储在 `users` 表 |
| 绑定 | 小程序用户与入住客户建立关联关系 |
| 陪护餐 | 为入住客户家属提供的餐食 |
| 积分价 | 商品的积分兑换价格 |
| 现金价 | 商品的人民币购买价格 |
